<div class="col-md-12">

<% player_name ||= lambda do |player_id|
     player = player_id && @players[player_id]
     player&.name || '—'
   end %>

<div class="tab2-content tab2-content-classification">

<div class="col-md-6">
<table class="table table-condensed table-striped">
<tr><th class="col-md-1 text-right">Pos</th><th class="col-md-4 text-left">Player</th><th class="col-md-2 text-right">Points</th><th class="col-md-2 text-right"># Rivals</th><th class="col-md-2 text-right"># Matches</th><th>Detail</th></tr>
<% @classification.each do |c| %>
<tr><td class="text-right"><%= c[:position] %></td><td class="text-left"><a href="#" class="player-details" data-toggle="modal" data-target="#player-modal" data-division-id="<%= @division_id %>" data-player-id="<%= c[:player_id] %>"><%= player_name.call(c[:player_id]) %></a></td><td class="text-right"><span title="<%= "#{'%.2f' % c[:points]}" %>"><%= "#{'%.0f' % c[:points]}" %></span></td><td class="text-right"><%= c[:num_rivals] %></td><td class="text-right"><%= c[:num_matches] %><% if @total_matches[c[:player_id]] %> / <%= @total_matches[c[:player_id]] %><% end %></td><td class="text-right"><a href="#" class="player-rivals" data-player-id="<%= c[:player_id] %>"><span class="glyphicon glyphicon-triangle-right"></span></a></tr>
<% end %>
</table>
</div>

<% @rivals.each do |p,data| %>
<div class="classification-detail col-md-6" id="classification-detail-<%= p %>" style="display: none">
<table class="table table-condensed">
<tr><th colspan="4">Classification details for <%= player_name.call(p) %></th></tr>
<tr><th>Rival</th><th class="text-right">Points</th><th class="text-right">Victories</th><th class="text-right">Defeats</th></tr>
<% data.each do |points, victories, defeats, r| %>
<% if points == -1 %>
<tr><td><%= player_name.call(r) %></td><td class="text-center" colspan="3">No matches yet</td></tr>
<% else %>
<tr><td><%= player_name.call(r) %></td><td class="text-right"><span title="<%= "#{'%.2f' % points}" %>"><%= "#{'%.0f' % points}" %></span></td><td class="text-right"><%= victories %></td><td class="text-right"><%= defeats %></td></tr>
<% end %>
<% end %>
</table>
</div>
<% end %>

</div>

<div class="tab2-content tab2-content-matches">

<div class="col-md-12">
<% players_sorted = @players.values.sort_by { |player| player.name.to_s.downcase } %>
<h4>Create quick match</h4>
<form id="quick-match-form" class="form-inline" data-division-id="<%= @division_id %>">
  <div class="row">
    <div class="col-sm-6 col-md-3 form-group">
      <label class="sr-only" for="quick-match-mode">Match mode</label>
      <select class="form-control" id="quick-match-mode" name="mode">
        <option value="doubles" selected>Doubles</option>
        <option value="singles">Singles</option>
      </select>
    </div>
  </div>
  <div class="row">
    <div class="col-sm-6 col-md-3 form-group quick-match-player-group" data-slot="0">
      <label class="sr-only" for="quick-match-player1">Player 1</label>
      <select class="form-control quick-match-player" id="quick-match-player1" name="player1" data-slot="0" required>
        <option value="">Select player 1</option>
        <% players_sorted.each do |player| %>
          <option value="<%= player.id %>"><%= player.name %></option>
        <% end %>
      </select>
    </div>
    <div class="col-sm-6 col-md-3 form-group quick-match-player-group" data-slot="1">
      <label class="sr-only" for="quick-match-player2">Player 2</label>
      <select class="form-control quick-match-player" id="quick-match-player2" name="player2" data-slot="1" required>
        <option value="">Select player 2</option>
        <% players_sorted.each do |player| %>
          <option value="<%= player.id %>"><%= player.name %></option>
        <% end %>
      </select>
    </div>
    <div class="col-sm-6 col-md-3 form-group quick-match-player-group" data-slot="2">
      <label class="sr-only" for="quick-match-player3">Player 3</label>
      <select class="form-control quick-match-player" id="quick-match-player3" name="player3" data-slot="2" required>
        <option value="">Select player 3</option>
        <% players_sorted.each do |player| %>
          <option value="<%= player.id %>"><%= player.name %></option>
        <% end %>
      </select>
    </div>
    <div class="col-sm-6 col-md-3 form-group quick-match-player-group" data-slot="3">
      <label class="sr-only" for="quick-match-player4">Player 4</label>
      <select class="form-control quick-match-player" id="quick-match-player4" name="player4" data-slot="3" required>
        <option value="">Select player 4</option>
        <% players_sorted.each do |player| %>
          <option value="<%= player.id %>"><%= player.name %></option>
        <% end %>
      </select>
    </div>
  </div>
  <div class="row" style="margin-top: 10px;">
    <div class="col-sm-6 col-md-4 form-group">
      <label class="sr-only" for="quick-match-api-key">API Key</label>
      <input type="password" class="form-control" id="quick-match-api-key" name="api_key" placeholder="API key" required>
    </div>
    <div class="col-sm-6 col-md-2 form-group">
      <button type="submit" class="btn btn-primary" id="quick-match-submit">Create match</button>
    </div>
  </div>
</form>
<div id="quick-match-feedback" class="alert" style="display:none;"></div>
</div>

<% require 'rack/utils' %>
<% player_name_for_popover = lambda do |player_id|
     Rack::Utils.escape_html(player_name.call(player_id))
   end %>
<% format_team_label = lambda do |team_ids|
     names = Array(team_ids).map { |pid| player_name_for_popover.call(pid) }
     label = names.reject(&:empty?).join(' + ')
     label = '—' if label.empty?
     label
   end %>
<% match_popover_rows = lambda do |match|
     rows = []
     submatches = match.get_submatches
     if submatches.empty?
       rows << "<tr><td colspan='3' class='text-center'>No results</td></tr>"
     else
       submatches.each do |team1_ids, score_a, team2_ids, score_b|
         team1 = format_team_label.call(team1_ids)
         team2 = format_team_label.call(team2_ids)
         score_a_text = Rack::Utils.escape_html(score_a.nil? ? '-' : score_a.to_s)
         score_b_text = Rack::Utils.escape_html(score_b.nil? ? '-' : score_b.to_s)
         rows << "<tr><td class='text-right'>#{team1}</td><td>#{score_a_text}-#{score_b_text}</td><td>#{team2}</td></tr>"
       end
     end
     rows.join
   end %>

<div class="col-md-12">
<div class="match-scope-toolbar clearfix">
  <h4 class="pull-left">Matches pending to play</h4>
  <div class="pull-right">
    <div class="btn-group btn-group-xs" role="group" aria-label="Match filter">
      <button type="button" class="btn btn-default match-scope-toggle active" data-scope="all" aria-pressed="true">Alle</button>
      <button type="button" class="btn btn-default match-scope-toggle" data-scope="league" aria-pressed="false">Nur Liga</button>
      <button type="button" class="btn btn-default match-scope-toggle" data-scope="quick" aria-pressed="false">Nur Quick</button>
    </div>
  </div>
</div>
<% team_labels = ['Yellow team', 'Black team'] %>
<table class="table table-match-open" data-match-section="open">
  <thead>
    <tr>
      <th class="col-md-5">Yellow team</th>
      <th class="col-md-5">Black team</th>
      <th class="text-center col-md-2">Actions</th>
    </tr>
  </thead>
  <tbody>
  <% if @open_matches.empty? %>
    <tr>
      <td colspan="3" class="text-center text-muted">No matches pending.</td>
    </tr>
  <% else %>
    <% @open_matches.each do |m| %>
    <% quick = m.respond_to?(:quick_match?) ? m.quick_match? : (m.respond_to?(:quick_match) && m.quick_match) %>
    <% teams = m.players.each_slice(2).to_a %>
    <tr data-quick-match="<%= quick ? 'true' : 'false' %>">
      <% teams.each_with_index do |team_players, team_index| %>
        <% team_label = team_labels[team_index] || "Team #{team_index + 1}" %>
        <td class="match-team-cell">
          <div class="match-team-meta">
            <small class="text-muted match-team-role"><%= team_label %></small>
            <% if team_index.zero? && quick %>
              <span class="label label-warning match-type-label" title="Quick Match"><span class="glyphicon glyphicon-flash" aria-hidden="true"></span><span class="sr-only">Quick Match</span></span>
            <% end %>
          </div>
          <ul class="match-team-list">
            <% display_players = team_players.empty? ? [nil] : team_players %>
            <% display_players.each do |player_id| %>
              <li><span class="match-player-name"><%= player_name.call(player_id) %></span></li>
            <% end %>
          </ul>
        </td>
      <% end %>
      <td class="text-center">
        <button class="btn btn-default btn-xs" type="button" data-toggle="modal" data-target="#simulator-modal" data-match-id="<%= m.id %>">Predict</button>
      </td>
    </tr>
    <% end %>
  <% end %>
    <tr class="match-filter-empty-dynamic" style="display: none">
      <td colspan="3" class="text-center text-muted">No matches for the selected filter.</td>
    </tr>
  </tbody>
</table>
</div>

<div class="col-md-12">
<h4>Matches already played</h4>
<table class="table table-striped table-condensed table-match-finished" data-match-section="finished">
  <thead>
    <tr><th>Time</th><th>Yellow team</th><th>Black team</th><th class="text-center">Details</th><th class="text-center"><span class="glyphicon glyphicon-sort"></span></th><th class="text-center">Duration</th></tr>
  </thead>
  <tbody>
  <% if @finished_matches.empty? %>
    <tr>
      <td colspan="6" class="text-center text-muted">No matches have been played yet.</td>
    </tr>
  <% else %>
    <% @finished_matches.each do |m| %>
    <% quick = m.respond_to?(:quick_match?) ? m.quick_match? : (m.respond_to?(:quick_match) && m.quick_match) %>
    <% teams = m.players.each_slice(2).to_a %>
    <% victories = Array(m.victories) %>
    <tr data-quick-match="<%= quick ? 'true' : 'false' %>">
      <td>
        <%= m.get_time() %>
        <% if quick %>
          <span class="label label-warning match-type-label" title="Quick Match"><span class="glyphicon glyphicon-flash" aria-hidden="true"></span><span class="sr-only">Quick Match</span></span>
        <% end %>
      </td>
      <% teams.each_with_index do |team_players, team_index| %>
        <% team_label = team_labels[team_index] || "Team #{team_index + 1}" %>
        <% team_offset = team_index * team_players.length %>
        <td class="match-team-cell">
          <div class="match-team-meta">
            <small class="text-muted match-team-role"><%= team_label %></small>
          </div>
          <ul class="match-team-list">
            <% display_players = team_players.empty? ? [nil] : team_players %>
            <% display_players.each_with_index do |player_id, slot_index| %>
              <% victory_value = victories[team_offset + slot_index]
                 victory_display = (player_id.nil? || victory_value.nil?) ? '—' : victory_value %>
              <li>
                <span class="match-player-name"><%= player_name.call(player_id) %></span>
                <span class="label label-default match-player-victory"><%= victory_display %></span>
              </li>
            <% end %>
          </ul>
        </td>
      <% end %>
      <td class="text-center"><button class="btn btn-default btn-xs match-result-popover" data-toggle="popover" data-content="<table class='table table-condensed table-borderless'><%= match_popover_rows.call(m) %></table>">Details</button></td>
      <td class="text-center"><button class="btn btn-default btn-xs" type="button" data-toggle="modal" data-target="#history-modal" data-division-id="<%= @division_id %>" data-match-id="<%= m.id %>"><span class="glyphicon glyphicon-sort"></span></button></td>
      <td class="text-center"><%= m.get_duration() %></td>
    </tr>
    <% end %>
  <% end %>
    <tr class="match-filter-empty-dynamic" style="display: none">
      <td colspan="6" class="text-center text-muted">No matches for the selected filter.</td>
    </tr>
  </tbody>
</table>
</div>

</div>

<div class="modal" id="simulator-modal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        <h4 class="modal-title" id="simulator-title">Match predictor</h4>
      </div>
      <div class="modal-body container" id="simulator-content">
      </div>
    </div>
  </div>
</div>

<div class="modal" id="history-modal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        <h4 class="modal-title" id="history-title">Classification history</h4>
      </div>
      <div class="modal-body container" id="history-content">
      </div>
    </div>
  </div>
</div>

<div class="modal" id="player-modal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        <h4 class="modal-title" id="player-title">Player details</h4>
      </div>
      <div class="modal-body container" id="player-content">
      </div>
    </div>
  </div>
</div>
